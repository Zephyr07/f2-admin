<div class="row border-bottom bd-lightGray m-3" style="margin-top:52px !important;">
  <div class="cell-md-4 d-flex flex-align-center">
    <h3 class="dashboard-section-title  text-center text-left-md w-100">Factures</h3>
  </div>

  <div class="cell-md-8 d-flex flex-justify-center flex-justify-end-md flex-align-center">
    <ul class="breadcrumbs bg-transparent">
      <li class="page-item"><a (click)="getBills(true)" class="page-link">Actualiser <span class="icon"><span
        class="mif-refresh"></span></span></a></li>
    </ul>
  </div>
</div>

<div class="m-3"
     infinite-scroll
     [infiniteScrollDistance]="scrollDistance"
     [infiniteScrollUpDistance]="scrollUpDistance"
     [infiniteScrollThrottle]="throttle"
     (scrolled)="onScrollDown($event)"
     (scrolledUp)="onUp($event)"
     [infiniteScrollContainer]="'.main-panel'"
     [alwaysCallback]="true"
>
  <div class="row mt-2">
    <div class="cell-3">
      <m4-input [(ngModel)]="search"
                placeholder="N° Facture"
                (ngModelChange)="vide()"
                (focusout)="rechercher()"
                [ngModelOptions]="{standalone: true}"
                [search-button]="true" (search-button-click)="rechercher()"></m4-input>
    </div>
    <div class="cell-2 hide">
      Afficher
      <div class="form-group">
        <select [(ngModel)]="per_page">
          <option value="25">25</option>
          <option value="50">50</option>
          <option value="100">100</option>
          <option value="200">200</option>
          <option value="500">500</option>
        </select>
      </div>
    </div>
    <div class="cell-4" *ngIf="state">
      Chargement des données ...
      <div data-role="progress" data-cls-back="bg-noir" data-type="line" data-small="true"></div>
    </div>

    <button *ngxPermissionsOnly="['advance.bill']" class="button ml-auto mr-2" (click)="avancer()">Avancer</button>
    <button *ngxPermissionsOnly="['cash.bill']" class="button mr-2 " (click)="openBillModal()">Encaisser</button>

  </div>

  <div
    class="row mt-2 main-panel"
    style="max-height: 490px; overflow-y: scroll"

  >
    <table class="table cell-border compact table-border"
    >
      <thead>
      <tr>
        <th data-sortable="true" data-sort-dir="asc" data-name="facture">N° Facture</th>
        <th data-sortable="true">Date</th>
        <th data-sortable="true" data-name="client">Client</th>
        <th data-sortable="true">Montant</th>
        <th data-sortable="true">Avance</th>
        <th data-sortable="true">Reste</th>
        <th data-sortable="true">Statut</th>
        <th>Selectionner</th>
      </tr>
      </thead>
      <tbody>
      <!--tr *ngFor="let i of factures"-->
      <tr
        *ngFor="let i of factures;trackBy:trackByIndex |filter:{ id: search, name: search, creation_date: search, amount: search, status: search } : false"
        [ngClass]="{'bg-or':i.check==true}"
         >
        <td>{{i.bvs_id}}</td>
        <td>{{i.creation_date}}</td>
        <td>{{i.name}}</td>
        <td>{{i.amount}}</td>
        <td>{{i.avance}}</td>
        <td>{{i.amount - i.avance}}</td>
        <td>{{i.statut}}</td>
        <td>
          <button class="button mini bg-noir fg-white" (click)="billChecked(i,true)" *ngIf="!i.check">
            Sélectionner
          </button>
          <button class="button mini" (click)="billChecked(i,false)" *ngIf="i.check">Désélectionner</button>
        </td>
      </tr>

      </tbody>
    </table>
  </div>

  <div class="cell-2">
    <small>{{factures.length}} sur {{max_length}} Factures</small>
  </div>

  <div class="dialog encaissementDialog" data-role="dialog" id="demoDialog1">
    <div class="dialog-title">Encaissement</div>
    <div class="dialog-content" *ngIf="selected_bill.length>0">
      Souhaitez-vous encaisser les factures ci-dessous ?
      <table class="table compact">
        <thead>
        <tr>
          <th>N° Facture</th>
          <th>Date</th>
          <th data-sortable="true">Montant</th>
          <th data-sortable="true">Avance</th>
          <th data-sortable="true">Reste</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let i of selected_bill">
          <td>{{i.bvs_id}}</td>
          <td>{{i.creation_date}}</td>
          <td>{{i.amount}}</td>
          <td>{{i.avance}}</td>
          <td>{{i.amount - i.avance}}</td>
        </tr>

        </tbody>
      </table>
      <div class="form-group">
        <label>Mode de paiement</label>
        <select [(ngModel)]="payment_method">
          <option value="Chèque">Chèque</option>
          <option value="Espèce">Espèce</option>
          <option value="Paiement mobile">Paiement mobile</option>
        </select>
      </div>
      <div *ngIf="payment_method == 'Chèque'">
        <div class="form-group">
          <label>Date</label>
          <m4-calendar-picker [(ngModel)]="commentaire3" cls-calendar="compact"
                              [dialog-mode]="true"
                              locale="fr-FR" format="%d/%m/%Y" size="100%"
                              calendar-button-icon="<span class='mif-calendar'></span>"
                              [show-header]="true"></m4-calendar-picker>
        </div>
        <div class="form-group">
          <label>Banque</label>
          <input type="text" [(ngModel)]="commentaire2" placeholder="Banque"/>
        </div>
        <div class="form-group">
          <label>N° du chèque</label>
          <input type="text" [(ngModel)]="commentaire1" placeholder="N° du chèque"/>
        </div>
      </div>

      <div *ngIf="payment_method == 'Espèce'">
        <div class="form-group">
          <label>Commentaire</label>
          <input type="text" [(ngModel)]="commentaire1" placeholder="Commentaire"/>
        </div>
      </div>

      <div *ngIf="payment_method == 'Paiement mobile'">
        <div class="form-group">
          <label>N° de la transaction</label>
          <input type="text" [(ngModel)]="commentaire1" placeholder="N° de la transaction"/>
        </div>
        <div class="form-group">
          <label>Opérateur</label>
          <input type="text" [(ngModel)]="commentaire2" placeholder="Opérateur"/>
        </div>
      </div>
    </div>
    <div class="dialog-content" *ngIf="selected_bill.length<=0">
      Aucune facture selectionnée.
    </div>
    <div class="dialog-actions text-right">
      <button class="button js-dialog-close bg-or fg-white" (click)="validerEncaissement()"
              *ngIf="selected_bill.length>0">Oui
      </button>
      <button class="button primary js-dialog-close bg-noir" *ngIf="selected_bill.length>0">Non</button>
      <button class="button primary js-dialog-close bg-noir" *ngIf="selected_bill.length<=0">Fermer</button>
    </div>
  </div>

  <div class="dialog" data-role="dialog" id="avanceDialog1">
    <div class="dialog-title">Avance de paiement sur facure {{facture.bvs_id}}</div>
    <div class="dialog-content">
      Combien souhaitez-vous avancer ?
      <div class="form-group">
        <label>Montant</label>
        <input type="number" [(ngModel)]="montant_avance" min="0" max="{{facture.amount-facture.avance}}"
               placeholder="Montant de l'avance"/>
        <small class="text-muted">Reste à payer : {{facture.amount - facture.avance}} FCFA</small>
      </div>
      <div class="form-group">
        <label>Mode de paiement</label>
        <select [(ngModel)]="payment_method">
          <option value="Chèque">Chèque</option>
          <option value="Espèce">Espèce</option>
          <option value="Paiement mobile">Paiement mobile</option>
        </select>
      </div>
      <div *ngIf="payment_method == 'Chèque'">
        <div class="form-group">
          <label>Date {{commentaire3}}</label>
          <m4-calendar-picker [(ngModel)]="commentaire3" cls-calendar="compact"
                              [dialog-mode]="true"
                              locale="fr-FR" format="%d/%m/%Y" size="100%"
                              calendar-button-icon="<span class='mif-calendar'></span>"
                              [show-header]="true"></m4-calendar-picker>
        </div>
        <div class="form-group">
          <label>Banque</label>
          <input type="text" [(ngModel)]="commentaire2" placeholder="Banque"/>
        </div>
        <div class="form-group">
          <label>N° du chèque</label>
          <input type="text" [(ngModel)]="commentaire1" placeholder="N° du chèque"/>
        </div>
      </div>

      <div *ngIf="payment_method == 'Espèce'">
        <div class="form-group">
          <label>Commentaire</label>
          <input type="text" [(ngModel)]="commentaire1" placeholder="Commentaire"/>
        </div>
      </div>

      <div *ngIf="payment_method == 'Paiement mobile'">
        <div class="form-group">
          <label>N° de la transaction</label>
          <input type="text" [(ngModel)]="commentaire1" placeholder="N° de la transaction"/>
        </div>
        <div class="form-group">
          <label>Opérateur</label>
          <input type="text" [(ngModel)]="commentaire2" placeholder="Opérateur"/>
        </div>
      </div>


    </div>

    <div class="dialog-actions text-right">
      <button class="button js-dialog-close bg-or fg-white" (click)="validerAvance()">Valider</button>
      <button class="button primary js-dialog-close bg-noir">Fermer</button>
    </div>
  </div>
</div>
